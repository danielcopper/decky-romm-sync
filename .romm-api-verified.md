# RomM 4.6.1 API — Verified Behavior (2026-02-19)

Tested live against http://192.168.178.83:8085 (RomM v4.6.1)

## Save Endpoints

| Endpoint | Method | Status | Notes |
|---|---|---|---|
| `/api/saves?rom_id={id}` | GET | **Works** | Returns PLAIN ARRAY (not {items} or {saves}). Each item: id, rom_id, user_id, file_name, file_name_no_tags, file_name_no_ext, file_extension, file_path, file_size_bytes, full_path, download_path, missing_from_fs, created_at, updated_at, emulator, screenshot |
| `/api/saves/{id}` | GET | **Works** | Returns metadata JSON only (same schema as list item) |
| `/api/saves?rom_id={id}&emulator={emulator}` | POST | **Works** | Multipart field: `saveFile`. Does UPSERT by filename — if save with same file_name+rom_id+user_id exists, updates in place (same ID preserved). No need to delete first. |
| `/api/saves/{id}` | PUT | **Works** | Multipart field: `saveFile`. Updates existing save file + metadata. |
| `/api/saves/{id}/content` | GET | **404** | DOES NOT EXIST in 4.6.1 |
| `{download_path}` | GET | **Works** | URL from save metadata. Must URL-encode spaces (%20) and parentheses (%28/%29). Returns binary file. |
| `/api/saves/delete` | POST | **Works** | Body: `{"saves": [id, ...]}` — but NOT NEEDED since POST does upsert |

## Notes Endpoints (for playtime)

| Endpoint | Method | Status | Notes |
|---|---|---|---|
| `/api/roms/{id}/notes` | POST | **Works** | Creates note. DO NOT send `tags` field (contributes to GET bug). Fields: title, content, is_public |
| `/api/roms/{id}/notes/{note_id}` | PUT | **Works** | Updates note content |
| `/api/roms/{id}/notes/{note_id}` | DELETE | **Works** | Deletes note |
| `/api/roms/{id}/notes` | GET | **500 BUG** | Returns 500 whenever ANY note exists. RomM bug. |
| `/api/roms/{id}/notes/{note_id}` | GET | **405** | Method Not Allowed — only PUT/DELETE on individual notes |

### Notes Workaround

`GET /api/roms/{id}` returns `all_user_notes` array with full note objects (id, title, content, is_public, tags, created_at, updated_at, user_id, username). Filter by `title == "romm-sync:playtime"` to find our note.

## device_id

- `device_id` query param on POST /api/saves is ACCEPTED but IGNORED on 4.6.1
- No server-side conflict detection (no 409 responses)
- Keep device_id in local state and note content for future 4.7.x compatibility
- Do NOT pass device_id in API calls

## What Does NOT Exist in 4.6.1

- `content_hash` field in SaveSchema
- `GET /api/saves/{id}/content` endpoint
- Server-side device tracking / conflict detection
- Playtime API (only `last_played` datetime via `PUT /api/roms/{id}/props`)
- Save slots

## Conflict Detection Strategy (Hybrid)

Since no content_hash exists:
1. **Local change**: MD5 hash of local file vs stored `last_sync_hash`
2. **Server change fast path**: compare `updated_at` + `file_size_bytes` with stored values. Both unchanged → skip.
3. **Server change slow path** (timestamp changed): download server save to tmp, MD5 hash it, compare with `last_sync_hash`. Same hash → false alarm. Different → real change.
4. **State recovery** (no last_sync_hash): download + hash both sides. Identical → auto-synced. Different → ask user.

## Playtime Note Content

```json
{
  "title": "romm-sync:playtime",
  "content": "{\"seconds\": 642, \"updated\": \"2026-02-19T20:03:00Z\", \"device\": \"steamdeck\"}",
  "is_public": false
}
```

## RomM 4.7.0-alpha.1 (Released 2026-02-12)

NOT available on user's server yet, but has:
- Device registration endpoints (POST /api/devices)
- `content_hash` in SaveSchema
- `GET /api/saves/{id}/content` for download
- Server-side 409 conflict detection via device sync tracking
- Save slots
- Feature request #1225 for playtime API still open

When user upgrades, we can simplify: use content_hash, server-side conflicts, proper download endpoint.
